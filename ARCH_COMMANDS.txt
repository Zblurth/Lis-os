# ARCH INSTALL COMMANDS
# Copy-paste ready - just replace YOUR_SSID and YOUR_PASSWORD
# Download: curl -O https://raw.githubusercontent.com/Zblurth/Lis-os/main/ARCH_COMMANDS.txt

# ========== PHASE 1: LIVE USB ==========
iwctl
# Inside iwctl:
# device list
# station wlan0 scan
# station wlan0 get-networks
# station wlan0 connect "YOUR_SSID"
# exit

ping -c3 archlinux.org
timedatectl set-ntp true

# ========== PHASE 2: CACHYOS REPOS ==========
pacman-key --recv-keys F3B607488DB35A47 --keyserver keyserver.ubuntu.com
pacman-key --lsign-key F3B607488DB35A47
pacman -Sy
curl https://mirror.cachyos.org/cachyos-repo.tar.xz -o cachyos-repo.tar.xz
tar xvf cachyos-repo.tar.xz && cd cachyos-repo
./cachyos-repo.sh
cd ..

# ========== PHASE 3: PARTITIONING (FLAT LAYOUT) ==========
# Replace nvme0n1 with your disk (vda for VM)

# Create partitions
fdisk /dev/nvme0n1
# g (GPT)
# n, 1, default, +1G (EFI)
# t, 1 (EFI System)
# n, 2, default, default (Root)
# w

# Format
mkfs.fat -F32 /dev/nvme0n1p1
mkfs.btrfs /dev/nvme0n1p2

# Create FLAT subvolumes
mount /dev/nvme0n1p2 /mnt
btrfs subvolume create /mnt/@
btrfs subvolume create /mnt/@home
btrfs subvolume create /mnt/@snapshots
btrfs subvolume create /mnt/@var_log
btrfs subvolume create /mnt/@var_pkg
btrfs subvolume create /mnt/@swap
umount /mnt

# Mount everything
mount -o noatime,compress=zstd,subvol=@ /dev/nvme0n1p2 /mnt
mkdir -p /mnt/{home,.snapshots,var/log,var/cache/pacman/pkg,swap,efi}
mount -o noatime,compress=zstd,subvol=@home /dev/nvme0n1p2 /mnt/home
mount -o noatime,compress=zstd,subvol=@snapshots /dev/nvme0n1p2 /mnt/.snapshots
mount -o noatime,compress=zstd,subvol=@var_log /dev/nvme0n1p2 /mnt/var/log
mount -o noatime,compress=zstd,subvol=@var_pkg /dev/nvme0n1p2 /mnt/var/cache/pacman/pkg
mount -o noatime,nodatacow,subvol=@swap /dev/nvme0n1p2 /mnt/swap
mount /dev/nvme0n1p1 /mnt/efi

# ========== PHASE 4: BASE INSTALL ==========
pacstrap -K /mnt base linux-cachyos linux-cachyos-headers linux-firmware btrfs-progs amd-ucode
pacstrap /mnt mesa-git vulkan-radeon networkmanager grub efibootmgr git base-devel

# Generate fstab
genfstab -U /mnt >> /mnt/etc/fstab

# ========== PHASE 5: CHROOT ==========
arch-chroot /mnt

# Timezone
ln -sf /usr/share/zoneinfo/Europe/Paris /etc/localtime
hwclock --systohc

# Locale
echo "en_GB.UTF-8 UTF-8" >> /etc/locale.gen
locale-gen
echo "LANG=en_GB.UTF-8" > /etc/locale.conf
echo "KEYMAP=us" > /etc/vconsole.conf

# Hostname
echo "archbox" > /etc/hostname

# Root password
passwd

# User
useradd -m -G wheel -s /bin/bash lune
passwd lune
EDITOR=vim visudo
# Uncomment: %wheel ALL=(ALL:ALL) ALL

# GRUB
grub-install --target=x86_64-efi --efi-directory=/efi --bootloader-id=GRUB
grub-mkconfig -o /boot/grub/grub.cfg

# Enable services
systemctl enable NetworkManager

# Exit and reboot
exit
umount -R /mnt
reboot

# ========== PHASE 6: FIRST BOOT ==========
nmtui
# Connect to WiFi

# Install paru
git clone https://aur.archlinux.org/paru.git
cd paru && makepkg -si
cd .. && rm -rf paru

# Install Niri
paru -S niri
sudo pacman -S alacritty firefox

# Start GUI
niri

# ========== PHASE 7: SNAPPER ==========
sudo pacman -S snapper snap-pac grub-btrfs
sudo snapper -c root create-config /
sudo sed -i 's/TIMELINE_LIMIT_HOURLY=.*/TIMELINE_LIMIT_HOURLY="5"/' /etc/snapper/configs/root
sudo sed -i 's/TIMELINE_LIMIT_DAILY=.*/TIMELINE_LIMIT_DAILY="7"/' /etc/snapper/configs/root
sudo sed -i 's/TIMELINE_LIMIT_WEEKLY=.*/TIMELINE_LIMIT_WEEKLY="2"/' /etc/snapper/configs/root
sudo sed -i 's/TIMELINE_LIMIT_MONTHLY=.*/TIMELINE_LIMIT_MONTHLY="1"/' /etc/snapper/configs/root
sudo sed -i 's/TIMELINE_LIMIT_YEARLY=.*/TIMELINE_LIMIT_YEARLY="0"/' /etc/snapper/configs/root
sudo systemctl enable --now snapper-timeline.timer
sudo systemctl enable --now snapper-cleanup.timer
sudo systemctl enable --now grub-btrfsd
sudo grub-mkconfig -o /boot/grub/grub.cfg

# ========== PHASE 8: DCLI ==========
paru -S dcli
dcli init
# Edit ~/.config/arch-config/hosts/archbox.yaml
# Edit ~/.config/arch-config/modules/*.yaml
dcli sync

# ========== VERIFY ==========
uname -r
# Should show: 6.x.x-cachyos
pacman -Q mesa-git
sudo snapper list
